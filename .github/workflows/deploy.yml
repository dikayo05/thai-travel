name: Auto Deploy Thai Travel

on:
  push:
    branches:
      - main # Pastikan branch utama kakak 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # 1. Masuk ke folder project Thai Travel
            # GANTI PATH INI dengan yang benar-benar ada di File Manager
            # Biasanya formatnya: /var/www/vhosts/domain-utama/subdomain-folder
            cd /var/www/vhosts/fts.biz.id/thai-travel.fts.biz.id

            # 2. Tarik kode terbaru
            git pull origin main

            # 3. Install Dependencies PHP (Pakai PHP 8.3 buat Laravel 12)
            # Kita pakai PHP 8.3 biar makin wuzz wuzz!
            /opt/plesk/php/8.3/bin/php /usr/lib64/plesk-9.0/composer.phar install --no-interaction --prefer-dist --optimize-autoloader

            # 4. Install & Build Frontend (Pakai Node 24)
            /opt/plesk/node/24/bin/npm install
            /opt/plesk/node/24/bin/npm run build

            # 5. Database & Cache Cleaning
            # Uncomment baris ini kalau mau auto-migrate database
            # /opt/plesk/php/8.3/bin/php artisan migrate --force

            /opt/plesk/php/8.3/bin/php artisan optimize:clear
            /opt/plesk/php/8.3/bin/php artisan config:cache
            /opt/plesk/php/8.3/bin/php artisan route:cache
            /opt/plesk/php/8.3/bin/php artisan view:cache

            # 6. Pastikan permission folder storage aman
            chmod -R 775 storage bootstrap/cache

            echo "DEPLOYMENT THAI TRAVEL SUKSES!"
